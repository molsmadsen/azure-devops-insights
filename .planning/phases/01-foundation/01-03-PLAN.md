---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - scripts/setup.mjs
  - skills/setup/SKILL.md
  - skills/help/SKILL.md
autonomous: true
requirements:
  - AUTH-01
  - AUTH-03

must_haves:
  truths:
    - "User runs /adi:setup and is prompted sequentially: org URL, then project name, then PAT"
    - "When prompted for PAT, user sees required scopes and a link to Azure DevOps PAT settings"
    - "On successful validation, user sees a summary: org URL, project name, masked PAT, privacy note, and 'try /adi:pr-metrics'"
    - "On re-run, user sees current config (PAT masked) and can update a single field without re-entering all values"
    - "On network failure, user is told the org URL is unreachable and prompted to re-enter it"
    - "On PAT failure, user is told the PAT was rejected and prompted to re-enter it"
    - "On permission failure, user sees which scope is missing and where to add it in Azure DevOps"
    - "User runs /adi:help and sees a list of all available /adi: commands with descriptions"
  artifacts:
    - path: "scripts/setup.mjs"
      provides: "Validates connection and writes config — invoked by setup skill with --org/--project/--pat flags"
      exports: []
      contains: "validateConnection"
    - path: "skills/setup/SKILL.md"
      provides: "Interactive /adi:setup skill — guides Claude through prompting user and invoking setup.mjs"
      contains: "disable-model-invocation"
    - path: "skills/help/SKILL.md"
      provides: "/adi:help skill — lists all commands"
      contains: "disable-model-invocation"
  key_links:
    - from: "skills/setup/SKILL.md"
      to: "scripts/setup.mjs"
      via: "!`node -e ...` dynamic injection to resolve plugin root, then node <root>/scripts/setup.mjs"
      pattern: "setup\\.mjs"
    - from: "skills/setup/SKILL.md"
      to: "scripts/setup.mjs"
      via: "--read flag to load existing config for re-run flow"
      pattern: "--read"
    - from: "scripts/setup.mjs"
      to: "scripts/ado-client.mjs"
      via: "import { validateConnection } from './ado-client.mjs'"
      pattern: "validateConnection"
    - from: "scripts/setup.mjs"
      to: "scripts/config.mjs"
      via: "import { saveConfig, maskPat, loadConfig, configExists } from './config.mjs'"
      pattern: "saveConfig"
---

<objective>
Build the setup script and both Phase 1 skills: `/adi:setup` (interactive config flow) and `/adi:help` (command listing). This is the user-facing layer of the foundation — setup.mjs handles validation and persistence, the skills tell Claude how to guide the user through it.

Purpose: AUTH-01 (setup flow), AUTH-03 (re-run without data loss). AUTH-02 (validation feedback) is delivered through the skill's narration of setup.mjs JSON output. The help skill satisfies the Phase 1 requirement that users can discover available commands.
Output: Working `/adi:setup` and `/adi:help` skills, plus `setup.mjs` that validates and saves credentials.
</objective>

<execution_context>
@C:/Users/7N_TSM/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/7N_TSM/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup script (setup.mjs)</name>
  <files>scripts/setup.mjs</files>
  <action>
Create `scripts/setup.mjs` as an ESM module. This script is invoked by the setup skill — not run interactively.

Two modes:
1. `--read` mode: Print current config (PAT masked) as JSON, then exit. Used by skill on re-run.
2. `--org=<url> --project=<name> --pat=<token>` mode: Validate connection, save config, print result as JSON.

```javascript
// scripts/setup.mjs
import { saveConfig, maskPat, loadConfig, configExists } from './config.mjs';
import { validateConnection } from './ado-client.mjs';

// Parse --key=value args from process.argv
const args = Object.fromEntries(
  process.argv.slice(2)
    .filter(a => a.startsWith('--'))
    .map(a => {
      const eq = a.indexOf('=');
      if (eq === -1) return [a.slice(2), true];
      return [a.slice(2, eq), a.slice(eq + 1)];
    })
);

// --read mode: print current config (PAT masked) for re-run detection
if (args.read) {
  if (!configExists()) {
    console.log(JSON.stringify({ exists: false }));
    process.exit(0);
  }
  const c = loadConfig();
  console.log(JSON.stringify({
    exists: true,
    orgUrl: c.orgUrl,
    project: c.project,
    pat: maskPat(c.pat)
  }));
  process.exit(0);
}

// --org/--project/--pat mode: validate and save
const { org, project, pat } = args;
if (!org || !project || !pat) {
  console.error(JSON.stringify({
    success: false,
    error: { type: 'usage', message: 'Usage: setup.mjs --org=<url> --project=<name> --pat=<token>' }
  }));
  process.exit(1);
}

const result = await validateConnection(org, project, pat);

if (!result.ok) {
  console.log(JSON.stringify({ success: false, error: result }));
  process.exit(1);
}

saveConfig({ orgUrl: org, project, pat });

console.log(JSON.stringify({
  success: true,
  summary: {
    orgUrl: org,
    project,
    pat: maskPat(pat)
  }
}));
```

Key implementation notes:
- Script outputs ONLY JSON to stdout — no human-readable strings. The SKILL.md tells Claude how to narrate the JSON.
- `pat` arg may contain `=` characters (PAT tokens often include them). Use `a.slice(eq + 1)` to capture everything after the first `=`.
- `args.read` uses `true` as value when `--read` has no `=`.
- On success: print `{ success: true, summary: { orgUrl, project, pat: masked } }`.
- On validation failure: print `{ success: false, error: { type, message, missingScope? } }` where `type` is one of `network`, `auth`, `permission`, `not_found`.
  </action>
  <verify>
    <automated>node --input-type=module --eval "
// Test arg parsing — PAT with = chars
const argv = ['--org=https://dev.azure.com/my-org', '--project=MyProject', '--pat=abc=def=xyz'];
const args = Object.fromEntries(
  argv.filter(a => a.startsWith('--'))
    .map(a => {
      const eq = a.indexOf('=');
      if (eq === -1) return [a.slice(2), true];
      return [a.slice(2, eq), a.slice(eq + 1)];
    })
);
console.assert(args.org === 'https://dev.azure.com/my-org', 'org: ' + args.org);
console.assert(args.project === 'MyProject', 'project: ' + args.project);
console.assert(args.pat === 'abc=def=xyz', 'PAT with = preserved: ' + args.pat);

// Test --read flag
const readArgv = ['--read'];
const readArgs = Object.fromEntries(
  readArgv.filter(a => a.startsWith('--'))
    .map(a => {
      const eq = a.indexOf('=');
      if (eq === -1) return [a.slice(2), true];
      return [a.slice(2, eq), a.slice(eq + 1)];
    })
);
console.assert(readArgs.read === true, '--read should be true, got: ' + readArgs.read);
console.log('OK: setup.mjs arg parsing logic verified');
"</automated>
    <manual>Confirm scripts/setup.mjs exists and outputs only JSON (no human-readable strings in console.log). Check that PAT arg parsing handles = chars by using indexOf('=') to find first occurrence.</manual>
  </verify>
  <done>setup.mjs handles --read mode (prints existing config with masked PAT) and --org/--project/--pat mode (validates, saves, prints JSON result). PAT values containing = characters are parsed correctly. All output is structured JSON for skill narration.</done>
</task>

<task type="auto">
  <name>Task 2: Setup and help skills (SKILL.md files)</name>
  <files>
    skills/setup/SKILL.md
    skills/help/SKILL.md
  </files>
  <action>
Create `skills/setup/SKILL.md`:

```markdown
---
name: setup
description: Configure your Azure DevOps connection (org URL, project name, PAT). Run this first.
disable-model-invocation: true
allowed-tools: Bash(node *)
---

Configure your Azure DevOps connection. Follow these steps exactly.

## Step 0: Check for existing config

Run this command to get the plugin root path and check for existing config:

```bash
PLUGIN_ROOT=`node -e "const f=require('fs'),h=require('os').homedir();try{const p=JSON.parse(f.readFileSync(h+'/.claude/plugins/installed_plugins.json','utf8'));const plugins=p.plugins||p;const e=Object.values(plugins).find(x=>String(x.name||x.pluginName||x.installPath||'').includes('adi'));console.log((e&&e.installPath)||process.env.CLAUDE_PLUGIN_ROOT||'.')}catch(e){console.log(process.env.CLAUDE_PLUGIN_ROOT||'.')}"` && node "$PLUGIN_ROOT/scripts/setup.mjs" --read
```

Parse the JSON output:
- If `exists: false` → proceed to Step 1 (full setup)
- If `exists: true` → show the user their current config:
  ```
  Current config:
    Org URL:  <orgUrl>
    Project:  <project>
    PAT:      <pat (masked)>

  Which field would you like to update? (org URL / project name / PAT / all)
  ```
  Based on the user's answer, only re-prompt the selected field(s). Keep the others from existing config.

## Step 1: Collect org URL

Ask: "What is your Azure DevOps org URL?"

Example: `https://dev.azure.com/my-org`

## Step 2: Collect project name

Ask: "What is the project name in that org?"

## Step 3: Collect PAT

Ask: "What is your Personal Access Token (PAT)?"

When asking for the PAT, include this guidance:

> **Required scopes** (create PAT at https://dev.azure.com/{org}/_usersSettings/tokens):
> - Code (Read)
> - Work Items (Read)
> - Project and Team (Read)
>
> Use minimum required scopes. The token will be stored in `~/.adi/config.json`.

## Step 4: Validate and save

Resolve plugin root and run setup:

```bash
PLUGIN_ROOT=`node -e "const f=require('fs'),h=require('os').homedir();try{const p=JSON.parse(f.readFileSync(h+'/.claude/plugins/installed_plugins.json','utf8'));const plugins=p.plugins||p;const e=Object.values(plugins).find(x=>String(x.name||x.pluginName||x.installPath||'').includes('adi'));console.log((e&&e.installPath)||process.env.CLAUDE_PLUGIN_ROOT||'.')}catch(e){console.log(process.env.CLAUDE_PLUGIN_ROOT||'.')}"` && node "$PLUGIN_ROOT/scripts/setup.mjs" --org="<org_url>" --project="<project_name>" --pat="<pat_token>"
```

Parse the JSON output and narrate:

**If `success: true`:**
> Connected to **<orgUrl>** / **<project>**.
> Config saved to `~/.adi/config.json` — keep this file private.
> You're ready — try `/adi:pr-metrics`

**If `error.type === 'network'`:**
> I can't reach that org URL. Please check: is `<orgUrl>` correct?
Then re-prompt for the org URL (Step 1) and retry validation.

**If `error.type === 'auth'`:**
> The PAT was rejected. It may be expired or invalid. Please enter a new PAT.
Then re-prompt for the PAT (Step 3) and retry validation.

**If `error.type === 'permission'` and `error.missingScope`:**
> The PAT is valid but missing the "**<missingScope>**" permission.
> Add this scope at: https://dev.azure.com/{org}/_usersSettings/tokens
> Once you've updated the PAT, paste the new token here.
Then re-prompt for the PAT (Step 3) and retry validation.

**If `error.type === 'not_found'`:**
> Project not found. Please check the project name — it should match exactly as shown in Azure DevOps.
Then re-prompt for the project name (Step 2) and retry validation.

Do NOT exit on validation failure — re-prompt only the failed field and retry.
```

Create `skills/help/SKILL.md`:

```markdown
---
name: help
description: List all available /adi: commands and their purpose.
disable-model-invocation: true
allowed-tools: []
---

List all available Azure DevOps Insights commands:

| Command | Description |
|---------|-------------|
| `/adi:setup` | Configure your Azure DevOps connection (org URL, project name, PAT). Run this first. |
| `/adi:help` | Show this help — list all available commands. |

**Coming in future versions:**
- `/adi:pr-metrics` — AI-narrated pull request health report
- `/adi:contributors` — Contributor activity analysis
- `/adi:bugs` — Bug health and trend report
- `/adi:sprint` — Current sprint status and backlog health
- `/adi:summary` — Project health synthesis across all signals
- `/adi:update` — Update the plugin to the latest version

**Getting started:**
1. Run `/adi:setup` to configure your Azure DevOps connection
2. Run `/adi:pr-metrics` to see your first report (available in Phase 2)
```

Key implementation notes for setup/SKILL.md:
- The `!`command`` plugin root resolver is the CRITICAL pattern from research. It reads `~/.claude/plugins/installed_plugins.json` to find the `adi` plugin's installPath. Falls back to `process.env.CLAUDE_PLUGIN_ROOT` (set during `--plugin-dir` development) or `.` as last resort.
- `disable-model-invocation: true` — setup only runs when explicitly invoked via `/adi:setup`
- `allowed-tools: Bash(node *)` — permits `node` execution without per-use permission dialog
- The skill uses PLUGIN_ROOT in a bash subshell so the same resolution works for both `--read` and the main setup invocation.
- The setup skill guides Claude's conversation — Claude collects values then calls the script once with all flags.
- Do NOT use `${CLAUDE_PLUGIN_ROOT}` directly in the skill body — it does not expand (confirmed bug).
  </action>
  <verify>
    <automated>node -e "
const f = require('fs');
const setup = f.readFileSync('skills/setup/SKILL.md', 'utf8');
const help = f.readFileSync('skills/help/SKILL.md', 'utf8');

// Setup skill checks
console.assert(setup.includes('disable-model-invocation: true'), 'setup: must have disable-model-invocation');
console.assert(setup.includes('allowed-tools: Bash(node *)'), 'setup: must allow node');
console.assert(setup.includes('installed_plugins.json'), 'setup: must use plugin root resolver');
console.assert(!setup.includes('\${CLAUDE_PLUGIN_ROOT}'), 'setup: must NOT use \${CLAUDE_PLUGIN_ROOT} directly');
console.assert(setup.includes('setup.mjs --read'), 'setup: must have --read for re-run flow');
console.assert(setup.includes('--org='), 'setup: must invoke setup.mjs with --org flag');
console.assert(setup.includes('error.type'), 'setup: must handle error types in narration');

// Help skill checks
console.assert(help.includes('disable-model-invocation: true'), 'help: must have disable-model-invocation');
console.assert(help.includes('/adi:setup'), 'help: must list /adi:setup');
console.assert(help.includes('/adi:help'), 'help: must list /adi:help');

console.log('OK: SKILL.md files verified');
"</automated>
    <manual>Open skills/setup/SKILL.md and confirm: (1) the plugin root resolver one-liner is present in the Bash blocks, (2) re-run flow shows current values, (3) each error type has a distinct narration with re-prompt instruction.</manual>
  </verify>
  <done>skills/setup/SKILL.md guides Claude through sequential prompts, uses plugin root resolver (not ${CLAUDE_PLUGIN_ROOT}), handles re-run by showing current config, narrates each error type distinctly with re-prompt instructions. skills/help/SKILL.md lists all Phase 1 commands with coming-soon placeholders for future phases.</done>
</task>

</tasks>

<verification>
- `scripts/setup.mjs` outputs only JSON — no raw strings in console.log
- `skills/setup/SKILL.md` contains `installed_plugins.json` resolver, NOT `${CLAUDE_PLUGIN_ROOT}`
- `skills/setup/SKILL.md` has `disable-model-invocation: true` and `allowed-tools: Bash(node *)`
- `skills/help/SKILL.md` has `disable-model-invocation: true`
- Re-run flow: Step 0 runs `--read`, shows masked current values, prompts which field to change
- All error types (network, auth, permission, not_found) have distinct narration with re-prompt instructions
- Run automated verify command — all assertions pass
</verification>

<success_criteria>
1. `/adi:setup` flow: sequential prompts → validation → success message with masked PAT + "try /adi:pr-metrics"
2. Re-run flow: shows current (masked) values, prompts for specific field to update
3. Error handling: three distinct messages for network/auth/permission failures, each re-prompts only the failed field
4. `/adi:help` lists all Phase 1 commands plus coming-soon placeholders
5. Skills use plugin root resolver — will work both locally (--plugin-dir) and after marketplace install
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` documenting:
- The plugin root resolver pattern used and why (CLAUDE_PLUGIN_ROOT bug)
- The --read / --org/--project/--pat dual-mode design of setup.mjs
- Confirmation that error types match between ado-client.mjs and setup SKILL.md narration
- Any deviations from the research patterns
</output>
