---
phase: 03-activity-skills
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [scripts/ado-client.mjs]
autonomous: true
requirements: []

must_haves:
  truths:
    - "adoGetCommits fetches commits for a given repo with date filtering"
    - "adoGetTeamMembers fetches team members for a project's default team"
    - "adoGetProject fetches project metadata including defaultTeam"
    - "adoWiql executes a WIQL POST query and returns work item IDs"
    - "adoGetWorkItemsBatch fetches work item details via POST with 200-ID chunking"
    - "All new functions accept explicit config (never call loadConfig internally)"
    - "POST functions handle 401/203/403 error classification like existing GET functions"
  artifacts:
    - path: "scripts/ado-client.mjs"
      provides: "Five new named exports for Phase 3 skills"
      exports: ["adoGetCommits", "adoGetTeamMembers", "adoGetProject", "adoWiql", "adoGetWorkItemsBatch"]
  key_links:
    - from: "scripts/ado-client.mjs"
      to: "Azure DevOps REST API"
      via: "fetch with buildAuthHeader"
      pattern: "buildAuthHeader\\(config\\.pat\\)"
---

<objective>
Extend ado-client.mjs with five new API functions needed by the contributors and bugs skills.

Purpose: Both new skills depend on API endpoints not yet in the client — Git Commits, Teams Members, Projects, WIQL, and Work Items Batch. Adding them to the shared client keeps error handling (203/401/403) centralized.

Output: scripts/ado-client.mjs with five new named exports, including the first POST endpoints in the codebase.
</objective>

<execution_context>
@/home/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-activity-skills/03-RESEARCH.md

@scripts/ado-client.mjs
@scripts/config.mjs

<interfaces>
<!-- Existing exports in ado-client.mjs that establish the pattern for new functions -->

From scripts/ado-client.mjs:
```javascript
export function buildAuthHeader(pat) { ... }
export async function adoGet(path, params = {}, configOverride = null) { ... }
export async function adoGetPrsByProject(config, params = {}) { ... }
export async function adoGetPrsByRepo(config, repoId, params = {}) { ... }
export async function adoGetPrThreads(config, repoId, prId) { ... }
export async function adoGetRepos(config) { ... }
export async function validateConnection(orgUrl, project, pat) { ... }
```

Key pattern: Every named function (except legacy `adoGet`) takes `config` as first argument. Config has: `config.orgUrl`, `config.project`, `config.pat`. All use `buildAuthHeader(config.pat)`. All construct URLs with `${orgBase}/${config.project}/_apis/...`. Error handling: try/catch for network errors, 401/203 → auth error, 403 → permission error.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GET functions — adoGetCommits, adoGetTeamMembers, adoGetProject</name>
  <files>scripts/ado-client.mjs</files>
  <action>
Add three new named exports to scripts/ado-client.mjs following the exact pattern of adoGetRepos (explicit config, URL construction, error handling).

**adoGetCommits(config, repoId, params = {}):**
- Endpoint: `git/repositories/${repoId}/commits`
- GET request with api-version=7.1
- Params forwarded to URL search params (e.g., `searchCriteria.fromDate`, `searchCriteria.$top`)
- Standard error handling: network → type:'network', 401/203 → type:'auth', 403 → type:'permission', other → type:'api'
- Returns parsed JSON (response shape: `{ value: [{ commitId, author: { name, email, date }, ... }] }`)

**adoGetTeamMembers(config, teamId):**
- Endpoint: `projects/${config.project}/teams/${teamId}/members`
- GET request with api-version=7.1
- Standard error handling same as above
- Returns parsed JSON (response shape: `{ value: [{ identity: { displayName, uniqueName, id } }] }`)

**adoGetProject(config):**
- Endpoint: `projects/${config.project}` (NOTE: this is project-level, NOT under `_apis` project-scoped path — the URL is `${orgBase}/_apis/projects/${config.project}`)
- GET request with api-version=7.1
- Standard error handling same as above
- Returns parsed JSON (response shape: `{ id, name, defaultTeam: { id, name } }`)
- IMPORTANT: URL pattern differs from other functions. This is org-scoped: `${orgBase}/_apis/projects/${config.project}` NOT `${orgBase}/${config.project}/_apis/projects/...`

All three functions must:
- Use `buildAuthHeader(config.pat)` for auth
- Include `'Content-Type': 'application/json'` header
- Follow the same try/catch + status check pattern as `adoGetRepos`
- NOT call `loadConfig()` internally — config is always explicit
  </action>
  <verify>
    <automated>grep -c "export async function adoGetCommits\|export async function adoGetTeamMembers\|export async function adoGetProject" scripts/ado-client.mjs | grep -q "3" && echo "PASS: 3 new GET exports found" || echo "FAIL"</automated>
  </verify>
  <done>Three new GET functions exported from ado-client.mjs. Each accepts explicit config, constructs the correct ADO URL, and handles errors with typed error objects matching the existing pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Add POST functions — adoWiql and adoGetWorkItemsBatch</name>
  <files>scripts/ado-client.mjs</files>
  <action>
Add two new named exports for POST endpoints — the first POST functions in the codebase.

**adoWiql(config, query, top = 500):**
- Endpoint: `wit/wiql` (project-scoped: `${orgBase}/${config.project}/_apis/wit/wiql`)
- HTTP POST with JSON body: `{ query }`
- URL params: `api-version=7.1`, `$top=${top}` (if top is truthy)
- Headers: Authorization (buildAuthHeader), Content-Type: application/json
- Error handling: network → type:'network', 401/203 → type:'auth', 403 → type:'permission' with message "PAT lacks Work Items (Read) permission.", other → type:'api'
- Returns parsed JSON (response shape: `{ workItems: [{ id, url }] }`)

**adoGetWorkItemsBatch(config, ids, fields):**
- Endpoint: `wit/workitemsbatch` (project-scoped: `${orgBase}/${config.project}/_apis/wit/workitemsbatch`)
- HTTP POST with JSON body: `{ ids, fields, errorPolicy: "omit" }`
- URL params: `api-version=7.1`
- Headers: Authorization (buildAuthHeader), Content-Type: application/json
- CRITICAL: This function handles chunking internally. If `ids.length > 200`, chunk into batches of 200, make sequential POST requests for each chunk, and merge results: `allItems = batches.flatMap(r => r.value || [])`. Return `{ value: allItems }`.
- Error handling same as adoWiql (network/auth/permission/api)
- Returns `{ value: [...workItems] }`

The key difference from GET functions: `method: 'POST'` and `body: JSON.stringify(...)` in the fetch options.

IMPORTANT: The `errorPolicy: "omit"` in workitemsbatch body tells ADO to skip items the PAT can't read instead of failing the whole batch.
  </action>
  <verify>
    <automated>grep -c "export async function adoWiql\|export async function adoGetWorkItemsBatch" scripts/ado-client.mjs | grep -q "2" && echo "PASS: 2 new POST exports found" || echo "FAIL"</automated>
  </verify>
  <done>Two new POST functions exported from ado-client.mjs. adoWiql sends WIQL queries. adoGetWorkItemsBatch fetches work items with internal 200-ID chunking and errorPolicy:"omit". Both handle errors consistently with GET functions.</done>
</task>

</tasks>

<verification>
- [ ] `scripts/ado-client.mjs` has 5 new named exports: adoGetCommits, adoGetTeamMembers, adoGetProject, adoWiql, adoGetWorkItemsBatch
- [ ] All 5 functions accept `config` as first argument (no internal loadConfig calls)
- [ ] POST functions use `method: 'POST'` and `body: JSON.stringify(...)`
- [ ] adoGetWorkItemsBatch chunks IDs into groups of 200
- [ ] All functions handle 401/203 (auth) and 403 (permission) errors
- [ ] adoGetProject uses org-scoped URL (`_apis/projects/${config.project}`)
- [ ] No npm dependencies added
- [ ] File parses without syntax errors: `node -c scripts/ado-client.mjs`
</verification>

<success_criteria>
scripts/ado-client.mjs exports all 5 new functions, each following the established pattern (explicit config, typed errors, buildAuthHeader). The file parses without errors. Contributors and bugs skills can import these functions directly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-activity-skills/03-01-SUMMARY.md`
</output>
