---
phase: 03-activity-skills
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: [scripts/contributors.mjs, skills/contributors/SKILL.md]
autonomous: true
requirements: []

must_haves:
  truths:
    - "Running /adi:contributors produces a narrative classifying team members as active, quiet, or former"
    - "Active contributors have commits in the time window and are on the team"
    - "Quiet contributors are on the team but have zero commits in the window"
    - "Former contributors have commits but are not on the team"
    - "--anonymous flag and config.anonymous hide contributor names"
    - "--days and --repo flags work consistently with pr-metrics"
    - "Conditional recommendations section appears only when actionable issues found"
  artifacts:
    - path: "scripts/contributors.mjs"
      provides: "Contributor data fetching and classification"
      min_lines: 80
    - path: "skills/contributors/SKILL.md"
      provides: "Claude narration instructions for contributor data"
      contains: "disable-model-invocation: true"
  key_links:
    - from: "scripts/contributors.mjs"
      to: "scripts/ado-client.mjs"
      via: "import named functions"
      pattern: "import.*adoGetCommits.*adoGetTeamMembers.*from.*ado-client"
    - from: "skills/contributors/SKILL.md"
      to: "scripts/contributors.mjs"
      via: "PLUGIN_ROOT resolver + node invocation"
      pattern: "node.*contributors\\.mjs"
---

<objective>
Build the /adi:contributors skill — script and SKILL.md — that classifies project contributors as active, quiet, or former based on commit history cross-referenced with team membership.

Purpose: Give team leads visibility into who's actively contributing, who has gone quiet, and who is no longer on the team — enabling proactive team management.

Output: scripts/contributors.mjs (data fetch + classification) and skills/contributors/SKILL.md (Claude narration instructions).
</objective>

<execution_context>
@/home/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-activity-skills/03-RESEARCH.md
@.planning/phases/03-activity-skills/03-CONTEXT.md

@scripts/ado-client.mjs
@scripts/config.mjs
@scripts/pr-metrics.mjs
@skills/pr-metrics/SKILL.md

<interfaces>
<!-- Functions available after Plan 01 completes -->

From scripts/ado-client.mjs (new in Plan 01):
```javascript
export async function adoGetCommits(config, repoId, params = {})
// GET git/repositories/{repoId}/commits — returns { value: [{ commitId, author: { name, email, date }, ... }] }

export async function adoGetTeamMembers(config, teamId)
// GET projects/{project}/teams/{teamId}/members — returns { value: [{ identity: { displayName, uniqueName, id } }] }

export async function adoGetProject(config)
// GET _apis/projects/{project} — returns { id, name, defaultTeam: { id, name } }
```

From scripts/ado-client.mjs (existing):
```javascript
export async function adoGetRepos(config)
// GET git/repositories — returns { value: [{ id, name, ... }] }
```

From scripts/config.mjs:
```javascript
export function loadConfig()   // Returns { orgUrl, project, pat, anonymous? }
export function configExists() // Returns boolean
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts/contributors.mjs</name>
  <files>scripts/contributors.mjs</files>
  <action>
Create scripts/contributors.mjs following the exact internal structure of pr-metrics.mjs.

**Imports:**
```javascript
import { loadConfig, configExists } from './config.mjs';
import { adoGetCommits, adoGetTeamMembers, adoGetProject, adoGetRepos } from './ado-client.mjs';
```

**Arg parsing** (copy pattern from pr-metrics.mjs):
- `--days=N` (default: 30)
- `--repo=name` (optional repo filter)
- `--anonymous` (hide names — also check `config.anonymous === true`)
- `--check-config` (Step 0 guard)

**Config check mode:** Same as pr-metrics — if `--check-config`, output `{ configMissing: bool }` and exit.

**Main flow:**

1. Load config via `loadConfig()`. Determine anonymous mode: `const anonymous = args.anonymous === 'true' || config.anonymous === true;`

2. Fetch repos via `adoGetRepos(config)`. If `--repo` specified, filter to matching repo (case-insensitive). If no match, output error JSON `{ error: { type: 'not_found', message: '...', availableRepos: [...] } }` and exit(1).

3. Fetch commits per repo sequentially (NOT parallel — rate limit safety):
   - For each repo: `adoGetCommits(config, repo.id, { 'searchCriteria.fromDate': sinceDate, 'searchCriteria.$top': '1000' })`
   - `sinceDate = new Date(Date.now() - days * 86400000).toISOString()`
   - Use `process.stderr.write(...)` for progress: `Fetching commits from ${repo.name}...\n`
   - Tolerate per-repo failures (try/catch, log warning to stderr, continue)

4. Aggregate commits by author email (lowercase): Build a map `{ email: { name: latestDisplayName, email, commitCount, repos: Set, lastCommitDate } }`. Keep the most recent `author.name` as display name.

5. Fetch team members:
   - `adoGetProject(config)` to get `defaultTeam.id`
   - `adoGetTeamMembers(config, defaultTeam.id)`
   - If either call fails, degrade gracefully: set `teamMembers = null`, skip classification, output all commit authors as "contributors" with a `teamDataUnavailable: true` flag

6. Classify contributors (when team data available):
   - Build `teamEmails = Set` of `member.identity.uniqueName.toLowerCase()`
   - Build `teamNameMap = Map` of email→displayName
   - For each commit author email:
     - In teamEmails → **active** (remove from set)
     - Not in teamEmails → **former**
   - Remaining teamEmails (no commits) → **quiet**
   - Sort each category: active by commitCount desc, quiet by name alpha, former by commitCount desc

7. Output JSON to stdout:
```json
{
  "summary": {
    "project": "...",
    "daysCovered": 30,
    "reposAnalyzed": 5,
    "repoNames": ["repo1", "repo2"],
    "totalCommits": 142,
    "teamName": "Project Team",
    "teamDataUnavailable": false
  },
  "active": [
    { "name": "Alice", "email": "alice@co.com", "commitCount": 45, "repos": ["repo1", "repo2"], "lastCommitDate": "..." }
  ],
  "quiet": [
    { "name": "Bob", "email": "bob@co.com" }
  ],
  "former": [
    { "name": "Charlie", "email": "charlie@co.com", "commitCount": 12, "repos": ["repo1"], "lastCommitDate": "..." }
  ]
}
```

8. Anonymous mode: If anonymous, replace all `name` fields with generic labels: active → "Active Contributor 1", quiet → "Team Member 1", former → "Former Contributor 1". Keep email addresses redacted too (replace with "---").

9. Error handling: Wrap main() in `.catch(e => { console.log(JSON.stringify({ error: { type: 'unexpected', message: e.message } })); process.exit(1); })`.

CRITICAL per CONTEXT.md decisions:
- No bus factor analysis
- No anomaly detection / spike-drop comparison
- Names shown by default; --anonymous hides them
- Risk framing for findings
- Conditional recommendations (only when issues found)
  </action>
  <verify>
    <automated>node -c scripts/contributors.mjs && echo "PASS: syntax OK" || echo "FAIL: syntax error"</automated>
  </verify>
  <done>scripts/contributors.mjs exists, parses without errors, imports from ado-client.mjs and config.mjs, supports --days/--repo/--anonymous/--check-config flags, classifies contributors as active/quiet/former, outputs JSON to stdout.</done>
</task>

<task type="auto">
  <name>Task 2: Create skills/contributors/SKILL.md</name>
  <files>skills/contributors/SKILL.md</files>
  <action>
Create skills/contributors/SKILL.md following the exact structure of skills/pr-metrics/SKILL.md.

**Frontmatter:**
```yaml
---
name: contributors
description: AI-narrated contributor activity report for your Azure DevOps project.
disable-model-invocation: true
allowed-tools: Bash(node *)
---
```

**Step 0: Guard — check config exists**
- Copy the PLUGIN_ROOT resolver one-liner verbatim from pr-metrics/SKILL.md
- Change script to `contributors.mjs --check-config`
- Same logic: if configMissing true, tell user to run /adi:setup, stop

**Step 1: Parse user arguments**
Extract from user's message:
- `--repo <name>` — filter to single repo
- `--days <n>` — override time window (default 30)
- `--anonymous` — hide contributor names

Build flags string.

**Step 2: Fetch and compute**
- Tell user: "Analyzing contributor activity in your Azure DevOps project..."
- Run: `node "$PLUGIN_ROOT/scripts/contributors.mjs" <flags>` (with PLUGIN_ROOT resolver)
- Parse JSON output

**Error handling** (same pattern as pr-metrics):
- `error.type === 'not_found'`: "Repository not found. Available repos: [list]. Try again with one of these."
- `error.type === 'auth'`: "Authentication failed. Run /adi:setup to reconfigure."
- `error.type === 'network'`: "Could not reach Azure DevOps. Check your network and org URL."
- Any other: "Something went wrong: [message]"

If `summary.totalCommits === 0`: "No commit activity found. Try broadening with `--days 90` or removing the `--repo` filter."

**Step 3: Write the narrative**

Opening line: "Analyzed **{summary.totalCommits} commits** across **{summary.reposAnalyzed} repos** ({repoNames}), last **{summary.daysCovered} days**. Team: **{summary.teamName}**."

If `summary.teamDataUnavailable === true`: Add note: "(Note: Could not access team roster — showing all commit authors without team classification.)"

Sections in order:

### Active Contributors
- List each active contributor with bold name, commit count, and repos
- e.g., "**Alice** — 45 commits (repo1, repo2)"
- Sort by commit count descending
- If empty: "No active contributors in this period."

### Quiet Team Members
- List team members with zero commits in the window
- e.g., "**Bob** — no commits in the last 30 days"
- Simple factual framing — no interpretation about why
- If empty: "All team members have been active."

### Former Contributors
- List people who committed but aren't on the team
- e.g., "**Charlie** — 12 commits (repo1) but no longer on the team"
- Per CONTEXT.md: simple factual framing — "3 contributors are no longer on the team", no interpretation about why they left
- If empty: "No former contributors detected."

### Recommendations
- Include ONLY when actionable issues found:
  - quiet.length > 0 (quiet team members)
  - former.length > 0 AND former contributors have significant commit counts
  - Very few active contributors relative to team size (risk framing)
- When included: 2-4 specific recommendations with risk framing per CONTEXT.md
- If no issues: omit section entirely

**Tone and style:**
- Direct and factual — naming names is intentional (unless --anonymous)
- Risk framing for findings per CONTEXT.md
- No padding or filler; every sentence has a data point or action
- Use bold for names and key numbers
- Sections separated by ### headers
  </action>
  <verify>
    <automated>test -f skills/contributors/SKILL.md && grep -q "disable-model-invocation: true" skills/contributors/SKILL.md && grep -q "contributors.mjs" skills/contributors/SKILL.md && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>skills/contributors/SKILL.md exists with correct frontmatter, Step 0 config guard with PLUGIN_ROOT resolver, Step 1 arg parsing, Step 2 fetch/compute with error handling, Step 3 narrative instructions covering active/quiet/former sections plus conditional recommendations.</done>
</task>

</tasks>

<verification>
- [ ] `scripts/contributors.mjs` parses without errors: `node -c scripts/contributors.mjs`
- [ ] `skills/contributors/SKILL.md` exists with `disable-model-invocation: true`
- [ ] contributors.mjs imports adoGetCommits, adoGetTeamMembers, adoGetProject from ado-client.mjs
- [ ] contributors.mjs supports --check-config, --days, --repo, --anonymous flags
- [ ] Anonymous mode reads from both CLI flag and config.anonymous
- [ ] SKILL.md uses the verbatim PLUGIN_ROOT resolver from pr-metrics
- [ ] Three contributor categories: active, quiet, former
- [ ] Recommendations section is conditional (only when issues found)
- [ ] No bus factor analysis (deferred per CONTEXT.md)
- [ ] No anomaly detection (deferred per CONTEXT.md)
</verification>

<success_criteria>
/adi:contributors skill fully defined: contributors.mjs fetches commits and team data, classifies contributors into active/quiet/former, outputs JSON. SKILL.md instructs Claude to narrate the data with risk framing and conditional recommendations. All CONTEXT.md locked decisions honored.
</success_criteria>

<output>
After completion, create `.planning/phases/03-activity-skills/03-02-SUMMARY.md`
</output>
