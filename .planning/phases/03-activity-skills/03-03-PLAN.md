---
phase: 03-activity-skills
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified: [scripts/bugs.mjs, skills/bugs/SKILL.md]
autonomous: true
requirements: []

must_haves:
  truths:
    - "Running /adi:bugs produces a narrative of open bugs by severity, age, and assignment"
    - "Top 5 oldest unresolved bugs are highlighted by name and age"
    - "Severity grouping is process-template agnostic (raw values, not hardcoded)"
    - "Assignment distribution shows who has bugs, unassigned bugs, and overloaded assignees"
    - "--types flag overrides default 'Bug' work item type"
    - "--days and --repo flags work consistently with other skills"
    - "Conditional recommendations section appears only when actionable issues found"
  artifacts:
    - path: "scripts/bugs.mjs"
      provides: "Bug data fetching and metrics computation"
      min_lines: 80
    - path: "skills/bugs/SKILL.md"
      provides: "Claude narration instructions for bug data"
      contains: "disable-model-invocation: true"
  key_links:
    - from: "scripts/bugs.mjs"
      to: "scripts/ado-client.mjs"
      via: "import named functions"
      pattern: "import.*adoWiql.*adoGetWorkItemsBatch.*from.*ado-client"
    - from: "skills/bugs/SKILL.md"
      to: "scripts/bugs.mjs"
      via: "PLUGIN_ROOT resolver + node invocation"
      pattern: "node.*bugs\\.mjs"
---

<objective>
Build the /adi:bugs skill — script and SKILL.md — that reports open bugs by severity, age, assignment distribution, and highlights the top 5 oldest unresolved.

Purpose: Give team leads a quick snapshot of bug debt — where it's concentrated, who's overloaded, and which old bugs pose delivery risk.

Output: scripts/bugs.mjs (WIQL query + batch fetch + metrics) and skills/bugs/SKILL.md (Claude narration instructions).
</objective>

<execution_context>
@/home/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-activity-skills/03-RESEARCH.md
@.planning/phases/03-activity-skills/03-CONTEXT.md

@scripts/ado-client.mjs
@scripts/config.mjs
@scripts/pr-metrics.mjs
@skills/pr-metrics/SKILL.md

<interfaces>
<!-- Functions available after Plan 01 completes -->

From scripts/ado-client.mjs (new in Plan 01):
```javascript
export async function adoWiql(config, query, top = 500)
// POST wit/wiql — body: { query } — returns { workItems: [{ id, url }] }

export async function adoGetWorkItemsBatch(config, ids, fields)
// POST wit/workitemsbatch — body: { ids, fields, errorPolicy: "omit" }
// Chunks internally at 200 IDs — returns { value: [...workItems] }
```

From scripts/config.mjs:
```javascript
export function loadConfig()   // Returns { orgUrl, project, pat }
export function configExists() // Returns boolean
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts/bugs.mjs</name>
  <files>scripts/bugs.mjs</files>
  <action>
Create scripts/bugs.mjs following the exact internal structure of pr-metrics.mjs.

**Imports:**
```javascript
import { loadConfig, configExists } from './config.mjs';
import { adoWiql, adoGetWorkItemsBatch } from './ado-client.mjs';
```

**Arg parsing** (copy pattern from pr-metrics.mjs):
- `--days=N` (default: 30 — used for age bucketing context, NOT for filtering bugs; bugs query returns ALL open bugs regardless of age)
- `--types=Bug,Defect,Issue` (default: "Bug" — comma-separated work item types)
- `--check-config` (Step 0 guard)

Note: `--repo` is NOT applicable to bugs (work items are project-scoped, not repo-scoped). Do not accept `--repo`.

**Config check mode:** Same as pr-metrics.

**Main flow:**

1. Load config. Parse types: `const types = (args.types || 'Bug').split(',').map(t => t.trim());`

2. Build and execute WIQL query:
```sql
SELECT [System.Id] FROM WorkItems
WHERE [System.WorkItemType] IN ({typeList})
  AND [System.State] NOT IN ('Closed', 'Resolved', 'Done')
  AND [System.TeamProject] = @project
ORDER BY [Microsoft.VSTS.Common.Severity] ASC, [System.CreatedDate] ASC
```
Where `typeList` is types mapped to `'Bug','Defect'` etc.
- Use `adoWiql(config, wiqlQuery, 500)` — $top=500 to avoid 20K cap
- Progress to stderr: `Querying open bugs...\n`

3. Extract IDs. If none: output summary with zero count and exit normally.

4. Batch fetch work item details:
```javascript
const fields = [
  'System.Id', 'System.Title', 'System.State', 'System.CreatedDate',
  'System.ChangedDate', 'System.AssignedTo',
  'Microsoft.VSTS.Common.Severity', 'Microsoft.VSTS.Common.Priority',
  'System.Tags'
];
const result = await adoGetWorkItemsBatch(config, ids, fields);
```
- Progress to stderr: `Fetching details for ${ids.length} bugs...\n`

5. Compute metrics:

**Severity breakdown** — process-template agnostic:
- Group by raw `Microsoft.VSTS.Common.Severity` value (or "Unspecified" if null)
- Sort: numeric prefix first (e.g., "1 - Critical" < "2 - High"), then alphabetical
- For each group: count and list of bug titles

**Age analysis:**
- For each bug: `ageDays = Math.floor((Date.now() - new Date(fields['System.CreatedDate']).getTime()) / 86400000)`
- Buckets: 0-7 days, 8-30 days, 31-90 days, 90+ days — count per bucket
- Mean and median age across all open bugs

**Top 5 oldest unresolved:**
- Sort by CreatedDate ascending, take first 5
- Include: id, title, severity, ageDays, assignedTo (name or "Unassigned"), createdDate

**Assignment distribution:**
- Group by `System.AssignedTo.displayName` (or "Unassigned" if null/empty)
- For each assignee: count of open bugs, list of severities
- Sort by count descending
- Flag overloaded: anyone with > 5 open bugs

6. Output JSON to stdout:
```json
{
  "summary": {
    "project": "...",
    "totalOpenBugs": 47,
    "queriedTypes": ["Bug"],
    "queryDate": "2026-02-26T..."
  },
  "severityBreakdown": {
    "1 - Critical": { "count": 3, "bugs": [{ "id": 123, "title": "..." }] },
    "2 - High": { "count": 12, "bugs": [...] }
  },
  "ageAnalysis": {
    "meanDays": 42.5,
    "medianDays": 28,
    "buckets": {
      "0-7 days": 5,
      "8-30 days": 18,
      "31-90 days": 15,
      "90+ days": 9
    }
  },
  "top5Oldest": [
    { "id": 101, "title": "Login fails on Safari", "severity": "2 - High", "ageDays": 187, "assignedTo": "Alice", "createdDate": "..." }
  ],
  "assignmentDistribution": [
    { "assignee": "Alice", "count": 8, "severities": { "2 - High": 3, "3 - Medium": 5 }, "overloaded": true },
    { "assignee": "Unassigned", "count": 5, "severities": { "3 - Medium": 5 }, "overloaded": false }
  ]
}
```

7. Error handling: Same pattern as pr-metrics — wrap main() in .catch().

CRITICAL per CONTEXT.md decisions:
- Snapshot of current open bugs, NOT trend over time
- Severity as opaque string (process-template agnostic)
- Types flag is invocation-only (not persisted)
- Configurable work item types default to "Bug"
- Top 5 oldest explicitly by name and age
  </action>
  <verify>
    <automated>node -c scripts/bugs.mjs && echo "PASS: syntax OK" || echo "FAIL: syntax error"</automated>
  </verify>
  <done>scripts/bugs.mjs exists, parses without errors, imports from ado-client.mjs and config.mjs, supports --types/--check-config flags, queries open bugs via WIQL, computes severity/age/assignment metrics, highlights top 5 oldest, outputs JSON to stdout.</done>
</task>

<task type="auto">
  <name>Task 2: Create skills/bugs/SKILL.md</name>
  <files>skills/bugs/SKILL.md</files>
  <action>
Create skills/bugs/SKILL.md following the exact structure of skills/pr-metrics/SKILL.md.

**Frontmatter:**
```yaml
---
name: bugs
description: AI-narrated open bug report for your Azure DevOps project.
disable-model-invocation: true
allowed-tools: Bash(node *)
---
```

**Step 0: Guard — check config exists**
- Copy the PLUGIN_ROOT resolver one-liner verbatim from pr-metrics/SKILL.md
- Change script to `bugs.mjs --check-config`
- Same logic: if configMissing true, tell user to run /adi:setup, stop

**Step 1: Parse user arguments**
Extract from user's message:
- `--types <list>` — override work item types (e.g., `--types "Bug,Defect,Issue"`)
- `--days <n>` — age context reference (default 30) — note: does NOT filter bugs, only used for context in narrative

Build flags string. Note: `--repo` is not applicable (work items are project-scoped).

**Step 2: Fetch and compute**
- Tell user: "Querying open bugs in your Azure DevOps project..."
- Run: `node "$PLUGIN_ROOT/scripts/bugs.mjs" <flags>` (with PLUGIN_ROOT resolver)
- Parse JSON output

**Error handling** (same pattern as pr-metrics):
- `error.type === 'auth'`: "Authentication failed. Run /adi:setup to reconfigure."
- `error.type === 'permission'`: "Your PAT needs the Work Items (Read) scope. Regenerate at your ADO PAT settings."
- `error.type === 'network'`: "Could not reach Azure DevOps. Check your network."
- Any other: "Something went wrong: [message]"

If `summary.totalOpenBugs === 0`: "No open bugs found (queried types: {queriedTypes}). If you expected bugs, try `--types 'Bug,Defect,Issue'` to broaden the search."

**Step 3: Write the narrative**

Opening line: "Found **{summary.totalOpenBugs} open bugs** in **{summary.project}** (queried type: {queriedTypes}). Snapshot as of {queryDate formatted}."

Sections in order:

### Severity Breakdown
- For each severity group (in order from severityBreakdown):
  - "**{severity}**: {count} bugs"
  - If severity starts with "1" or contains "Critical": add risk flag — "Delivery risk: {count} critical bugs remain open."
- If all bugs are low severity: note this positively

### Bug Age
- State mean and median age
- Show age buckets: "0-7 days: {N}, 8-30 days: {N}, 31-90 days: {N}, 90+ days: {N}"
- If `ageAnalysis.medianDays > 30`: flag — "Median bug age is {N} days — bugs are aging."
- If `ageAnalysis.buckets['90+ days'] > 0`: flag — "**{N} bugs** are over 90 days old."

### Top 5 Oldest Unresolved
- List each with bold title, severity, age, and assignee
- e.g., "1. **Login fails on Safari** — {severity}, {ageDays} days old, assigned to **{assignee}**"
- Per CONTEXT.md: highlighted explicitly by name and age
- If assignedTo is "Unassigned": flag it

### Assignment Distribution
- List assignees sorted by bug count (already sorted descending)
- For each: "**{assignee}** — {count} open bugs ({severity breakdown})"
- If overloaded === true: flag — "overloaded (>{5} open bugs)"
- Highlight unassigned bugs count separately: "**{N} bugs are unassigned** — no one is responsible for these."

### Recommendations
- Include ONLY when at least one condition:
  - Critical/high severity bugs exist (severity starts with "1" or "2")
  - ageAnalysis.medianDays > 30
  - Any assignee has overloaded === true
  - Unassigned bugs exist
- When included: 2-4 specific recommendations with RISK FRAMING per CONTEXT.md
  - Name specific people and bugs
  - e.g., "5 critical bugs open >30 days — delivery risk. Triage immediately."
  - e.g., "Alice has 8 open bugs — reassign 3 medium-severity items to balance the load."
- If no conditions met: omit section entirely

**Tone and style:**
- Direct and factual with risk framing per CONTEXT.md
- No padding or filler
- Use bold for titles, names, and key numbers
- Sections separated by ### headers
  </action>
  <verify>
    <automated>test -f skills/bugs/SKILL.md && grep -q "disable-model-invocation: true" skills/bugs/SKILL.md && grep -q "bugs.mjs" skills/bugs/SKILL.md && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>skills/bugs/SKILL.md exists with correct frontmatter, Step 0 config guard with PLUGIN_ROOT resolver, Step 1 arg parsing (--types), Step 2 fetch/compute with error handling, Step 3 narrative instructions covering severity/age/top5/assignment sections plus conditional recommendations with risk framing.</done>
</task>

</tasks>

<verification>
- [ ] `scripts/bugs.mjs` parses without errors: `node -c scripts/bugs.mjs`
- [ ] `skills/bugs/SKILL.md` exists with `disable-model-invocation: true`
- [ ] bugs.mjs imports adoWiql, adoGetWorkItemsBatch from ado-client.mjs
- [ ] bugs.mjs supports --check-config, --types flags
- [ ] --types defaults to "Bug", accepts comma-separated list
- [ ] Types flag is NOT persisted in config.json (invocation-only per CONTEXT.md)
- [ ] SKILL.md uses the verbatim PLUGIN_ROOT resolver from pr-metrics
- [ ] Severity grouping uses raw values (no hardcoded "1 - Critical" etc.)
- [ ] Top 5 oldest highlighted by name and age
- [ ] Assignment distribution shows overloaded and unassigned
- [ ] Recommendations section is conditional with risk framing
- [ ] No trend-over-time analysis (deferred per CONTEXT.md)
</verification>

<success_criteria>
/adi:bugs skill fully defined: bugs.mjs queries open bugs via WIQL, batch-fetches details, computes severity/age/assignment metrics, highlights top 5 oldest, outputs JSON. SKILL.md instructs Claude to narrate with risk framing and conditional recommendations. All CONTEXT.md locked decisions honored.
</success_criteria>

<output>
After completion, create `.planning/phases/03-activity-skills/03-03-SUMMARY.md`
</output>
