---
phase: 02-pr-metrics
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - skills/pr-metrics/SKILL.md
autonomous: false
requirements: [PR-06]

must_haves:
  truths:
    - "User can run `/adi:pr-metrics` and receive an AI-written narrative about PR health"
    - "Skill guards against missing config (runs --check-config before fetching)"
    - "Skill passes all user-supplied flags (--repo, --days, --stale-days, --project) to the script"
    - "Narrative opens with analyzed PR count, repo count, and time window"
    - "Narrative calls out specific reviewers by name for participation and bottlenecks"
    - "Recommendations section appears only when issues are found"
    - "Stale PR list is surfaced when stale PRs exist"
    - "Human verifies the full end-to-end flow produces a readable narrative"
  artifacts:
    - path: "skills/pr-metrics/SKILL.md"
      provides: "/adi:pr-metrics skill definition — guards, argument parsing, script invocation, narration instructions"
      contains: "pr-metrics.mjs"
      min_lines: 60
  key_links:
    - from: "skills/pr-metrics/SKILL.md"
      to: "scripts/pr-metrics.mjs"
      via: "Bash invocation in SKILL.md"
      pattern: "pr-metrics\\.mjs"
    - from: "skills/pr-metrics/SKILL.md"
      to: "installed_plugins.json resolver"
      via: "PLUGIN_ROOT resolver node one-liner (same as setup SKILL.md)"
      pattern: "installed_plugins\\.json"
---

<objective>
Create the /adi:pr-metrics skill definition and verify the complete end-to-end flow from user invocation to AI narrative.

Purpose: PR-06 requires the output to be an AI narrative — this plan wires the computed JSON from pr-metrics.mjs to Claude's narration instructions. The checkpoint confirms a human sees a readable, useful report.

Output:
- `skills/pr-metrics/SKILL.md` — complete skill definition
- Human-verified end-to-end flow
</objective>

<execution_context>
@C:/Users/7N_TSM/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/7N_TSM/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pr-metrics/02-CONTEXT.md
@.planning/phases/02-pr-metrics/02-01-SUMMARY.md
@skills/setup/SKILL.md
@scripts/pr-metrics.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create skills/pr-metrics/SKILL.md</name>
  <files>skills/pr-metrics/SKILL.md</files>
  <action>
Create `skills/pr-metrics/SKILL.md` following the exact structure of `skills/setup/SKILL.md`.

**Frontmatter:**
```yaml
---
name: pr-metrics
description: AI-narrated pull request health report for your Azure DevOps project.
disable-model-invocation: true
allowed-tools: Bash(node *)
---
```

**Step 0: Guard — check config exists**

Use the PLUGIN_ROOT resolver (identical one-liner from setup/SKILL.md) and run with `--check-config`:

```bash
PLUGIN_ROOT=`node -e "const f=require('fs'),h=require('os').homedir();try{const p=JSON.parse(f.readFileSync(h+'/.claude/plugins/installed_plugins.json','utf8'));const plugins=p.plugins||p;const e=Object.values(plugins).find(x=>String(x.name||x.pluginName||x.installPath||'').includes('adi'));console.log((e&&e.installPath)||process.env.CLAUDE_PLUGIN_ROOT||'.')}catch(e){console.log(process.env.CLAUDE_PLUGIN_ROOT||'.')}"` && node "$PLUGIN_ROOT/scripts/pr-metrics.mjs" --check-config
```

If output is `{"configMissing": true}`: tell the user "Run `/adi:setup` first to configure your Azure DevOps connection." and stop.

**Step 1: Parse user arguments**

Extract from the user's message (if present):
- `--repo <name>` — filter to a single repository
- `--days <n>` — override time window (e.g., `--days=90`)
- `--stale-days <n>` — override stale threshold (default: 3)
- `--project <name>` — override ADO project from config

Build the flags string: `[--repo=<name>] [--days=<n>] [--stale-days=<n>] [--project=<name>]` (omit any not provided by user).

**Step 2: Fetch and compute**

Tell the user: "Fetching PR data from Azure DevOps..."

Run:
```bash
PLUGIN_ROOT=`node -e "const f=require('fs'),h=require('os').homedir();try{const p=JSON.parse(f.readFileSync(h+'/.claude/plugins/installed_plugins.json','utf8'));const plugins=p.plugins||p;const e=Object.values(plugins).find(x=>String(x.name||x.pluginName||x.installPath||'').includes('adi'));console.log((e&&e.installPath)||process.env.CLAUDE_PLUGIN_ROOT||'.')}catch(e){console.log(process.env.CLAUDE_PLUGIN_ROOT||'.')}"` && node "$PLUGIN_ROOT/scripts/pr-metrics.mjs" <flags>
```

If the output contains `"error"` at the top level:
- `error.type === 'not_found'`: "Repository not found. Available repos: [error.availableRepos.join(', ')]. Try again with one of these names."
- `error.type === 'auth'`: "Authentication failed. Run `/adi:setup` to reconfigure your PAT."
- `error.type === 'network'`: "Could not reach Azure DevOps. Check your network and org URL."
- Any other error: "Something went wrong: [error.message]"

If `summary.totalPrs === 0`: "No PRs found for the selected scope. Try broadening with `--days 90` or removing the `--repo` filter."

**Step 3: Write the narrative**

Parse the JSON and write a narrative with these characteristics:

**Opening line** (always first):
"Analyzed **{summary.totalPrs} PRs** across **{summary.reposAnalyzed} repos** ({summary.repoNames.join(', ')}), last **{summary.daysCovered ?? 'all-time'} days**."
If `summary.capHit` is true: add "(Note: capped at 10,000 PRs — very large history)"

**Section: Review Speed**
Lead with time-to-first-review (PR-01):
- If `timeToFirstReview.meanHours` is not null: state mean and median
- Compare against threshold (4 hours): flag if above with "Above the 4-hour target"
- Include count of PRs above threshold if `aboveThresholdCount > 0`
- If `missingCount > 0`: "({missingCount} PRs had no review activity)"

**Section: Cycle Time** (PR-02):
- State mean and median cycle time in hours or days (use days if mean > 48h for readability)
- Only if `cycleTimes.prCount > 0`, else "No completed PRs in this window."

**Section: Reviewer Participation** (PR-03):
- List reviewers from `reviewerDistribution` (top 5 if more than 5)
- Name each reviewer and their review count
- If `absentReviewers.length > 0`: "The following team members submitted PRs but did not review others: {absentReviewers.join(', ')}."

**Section: Bottlenecks** (PR-05):
- If `bottleneck` is not null: name the person, state their avg time-to-review and review share
  - type='slow': "{name} averaged {N}h to first review — above the 4-hour target."
  - type='concentrated': "{name} reviewed {reviewShare*100}% of all PRs — single point of dependency."
  - type='both': combine both messages.
- If null: "No bottlenecks detected."

**Section: Stale PRs** (PR-04):
- If `stalePrs.length > 0`: list each with title, repo, age, author, and URL
- If empty: "No stale PRs (threshold: {thresholds.staleThresholdDays} days)."

**Section: Recommendations** (only when issues exist — per locked decision):
Include this section ONLY if at least one of these is true:
- `timeToFirstReview.aboveThresholdCount > 0`
- `bottleneck !== null`
- `stalePrs.length > 0`
- `absentReviewers.length > 0`

When included: write 2-4 specific, actionable recommendations based on the actual data (not generic advice). Name specific people and specific numbers.

**Tone and style** (Claude's discretion per CONTEXT.md):
- Direct and factual — this is a team lead tool; naming names is intentional
- No padding or filler; every sentence should contain a data point or action
- Use bold for names and key numbers
- Sections are separated by headers (## or ###)
  </action>
  <verify>
    <automated>node --input-type=module --eval "
import { readFileSync } from 'fs';
const src = readFileSync('./skills/pr-metrics/SKILL.md', 'utf8');
const checks = [
  ['frontmatter name', src.includes('name: pr-metrics')],
  ['disable-model-invocation', src.includes('disable-model-invocation: true')],
  ['allowed-tools bash node', src.includes('Bash(node *)')],
  ['check-config guard', src.includes('check-config')],
  ['configMissing guard', src.includes('configMissing')],
  ['PLUGIN_ROOT resolver', src.includes('installed_plugins.json')],
  ['pr-metrics.mjs invocation', src.includes('pr-metrics.mjs')],
  ['--repo flag', src.includes('--repo')],
  ['--days flag', src.includes('--days')],
  ['--stale-days flag', src.includes('stale-days')],
  ['Opening line totalPrs', src.includes('totalPrs')],
  ['timeToFirstReview narration', src.includes('timeToFirstReview')],
  ['cycleTimes narration', src.includes('cycleTimes')],
  ['reviewerDistribution narration', src.includes('reviewerDistribution')],
  ['absentReviewers narration', src.includes('absentReviewers')],
  ['stalePrs narration', src.includes('stalePrs')],
  ['bottleneck narration', src.includes('bottleneck')],
  ['recommendations conditional', src.includes('Recommendations')],
];
const failed = checks.filter(([,ok]) => !ok).map(([name]) => name);
if (failed.length) { console.error('MISSING IN SKILL.md:', failed.join(', ')); process.exit(1); }
console.log('OK: all required elements present in SKILL.md (' + checks.length + ' checks)');
" 2>/dev/null</automated>
    <manual>Review skills/pr-metrics/SKILL.md — confirm narration instructions are complete and the PLUGIN_ROOT resolver is identical to setup/SKILL.md</manual>
  </verify>
  <done>
    - skills/pr-metrics/SKILL.md exists with correct frontmatter
    - All 5 narrative sections defined (Review Speed, Cycle Time, Reviewer Participation, Bottlenecks, Stale PRs)
    - Recommendations section is conditional (only when issues found) — per locked CONTEXT.md decision
    - PLUGIN_ROOT resolver uses installed_plugins.json pattern from Phase 1
    - Error handling covers not_found, auth, network, and empty results
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify end-to-end /adi:pr-metrics skill</name>
  <action>
Automated pre-checks (run before asking user to verify):
1. `ls scripts/pr-metrics.mjs skills/pr-metrics/SKILL.md` — both must exist
2. `node -e "import('./scripts/ado-client.mjs').then(m => { const fns=['adoGetPrsByProject','adoGetPrsByRepo','adoGetPrThreads','adoGetRepos']; const missing=fns.filter(f=>typeof m[f]!=='function'); console.log(missing.length?'MISSING:'+missing:'ALL PR FUNCTIONS OK'); })"` — must print ALL PR FUNCTIONS OK
3. `node scripts/pr-metrics.mjs --check-config 2>/dev/null` — must output valid JSON
If any automated check fails, fix the issue before presenting to user.
  </action>
  <verify>
    <automated>node scripts/pr-metrics.mjs --check-config 2>/dev/null | node -e "let d='';process.stdin.on('data',c=>d+=c).on('end',()=>{try{const j=JSON.parse(d);console.log(typeof j.configMissing==='boolean'?'OK: check-config works':'FAIL: missing configMissing field');process.exit(typeof j.configMissing==='boolean'?0:1)}catch(e){console.error('FAIL: invalid JSON',e.message);process.exit(1)}})"</automated>
    <manual>
What was built:
- Plan 02-01: ado-client.mjs extended with 4 PR fetch functions; pr-metrics.mjs computes all metrics and outputs JSON
- Plan 02-02 Task 1: skills/pr-metrics/SKILL.md defines invocation, guards, and narration instructions

Verify with real ADO config (~/.adi/config.json):
1. Run `/adi:pr-metrics` in Claude Code
2. Confirm: narrative opens with "Analyzed N PRs across N repos..."
3. Confirm: Review Speed, Cycle Time, Reviewer Participation, Stale PRs sections all appear
4. Confirm: Recommendations section appears only if issues exist
5. Optionally: `/adi:pr-metrics --days=30` to verify flag passthrough
6. Error path: temporarily rename config, run skill, confirm "Run /adi:setup first" message

Type "approved" if readable and correct, or describe issues found.
    </manual>
  </verify>
  <done>Human approves: narrative opens with PR count summary, all sections present, recommendations conditional on issues, flags work correctly</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `ls skills/pr-metrics/SKILL.md` — file must exist
2. `node scripts/pr-metrics.mjs --check-config 2>/dev/null` — must output valid JSON
3. Skill narration instructions cover all 6 requirements: PR-01 (time-to-first-review), PR-02 (cycle time), PR-03 (reviewer distribution + absent), PR-04 (stale PRs), PR-05 (bottleneck), PR-06 (AI narrative output)
</verification>

<success_criteria>
- skills/pr-metrics/SKILL.md has correct frontmatter, guard, arg parsing, fetch invocation, and full narration instructions
- All PR-01 through PR-06 requirements addressed across plans 02-01 and 02-02
- Human approves the narrative output as readable and useful
- Phase 2 can be marked complete in STATE.md
</success_criteria>

<output>
After completion, create `.planning/phases/02-pr-metrics/02-02-SUMMARY.md`
</output>
